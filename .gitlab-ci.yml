# Use arch to build, we are not dependent on compiler version
image: debian:bookworm

# Build stages
stages:
    - test
    - build
# CI is non-interactive
variables:
  DEBIAN_FRONTEND: noninteractive
# Install base packages
before_script:
  - apt-get update -qq
  - apt-get install -yqq build-essential clang valgrind astyle doxygen pandoc musl
# Run all tests
test:
    stage: test
    script:
        - ./build.sh test CI
    rules:
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event' 
        - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
# Create cbuild.h header
build:
    stage: build
    script:
        - ./build.sh pack
    rules:
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event' 
        - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    artifacts:
        name: "$CI_COMMIT_REF_NAME"
        paths:
            - cbuild.h
# Build wiki
pages:
    script:
        - mkdir -p public
        - ./build.sh pack
        - ./build.sh docs wiki
        - ./build.sh docs doxygen
        - cp -r wiki/out/* public/
    artifacts:
        paths:
            - public
    rules:
        - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH